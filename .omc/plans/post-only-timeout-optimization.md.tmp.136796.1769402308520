# POST_ONLY and Timeout Optimization Plan

**Plan ID:** POST_ONLY_TIMEOUT_OPT
**Created:** 2026-01-26
**Status:** READY FOR IMPLEMENTATION
**Priority:** HIGH
**Estimated Complexity:** MEDIUM

---

## Executive Summary

**Objective:** Reduce trading cycle time by 25% (33s ‚Üí 25s) and eliminate GRVT taker fees (0.05% ‚Üí 0%) by converting GRVT from MARKET orders to POST_ONLY maker orders.

**Key Changes:**
1. ‚úÖ Timeout optimization: 10s ‚Üí 5s (ALREADY COMPLETE at line 750)
2. ‚ö†Ô∏è POST_ONLY conversion: GRVT hedge orders MARKET ‚Üí POST_ONLY (NEW)
3. üìä Validation: ETH 0.01 √ó 5 iterations test

**Expected Outcomes:**
- Cycle time: 33.32s ‚Üí ~25s (25% reduction)
- Fee savings: 0.05% per hedge leg (GRVT taker ‚Üí maker)
- Net PnL improvement: +$0.50 per cycle (from fee savings)

---

## Requirements Summary

### Primary Objectives

1. **GRVT POST_ONLY Conversion (MEDIUM Risk)**
   - Convert hedge orders from MARKET to POST_ONLY
   - Eliminate 0.05% taker fee on all GRVT hedge legs
   - Implement fallback logic for non-fill scenarios
   - Target: 0% maker fee vs current 0.05% taker fee

2. **Timeout Validation (LOW Risk)**
   - Verify 5s timeout is optimal (already implemented at line 750)
   - Monitor fill rate impact: expect 95% ‚Üí 80-90%
   - Document any timeout-related edge cases

3. **Performance Validation**
   - Test with ETH 0.01 √ó 5 iterations
   - Measure cycle time improvement
   - Track fee savings and net PnL impact
   - Success criteria: <25s average cycle time, positive net PnL

### Non-Objectives (Out of Scope)

- Changing Backpack exchange behavior (already POST_ONLY)
- Modifying entry/exit logic or strategy parameters
- Changing tick size or order quantity calculations
- Modifying emergency unwind or position management
- WebSocket or position sync logic changes

---

## Implementation Tasks

### Task 1: Verify Timeout Optimization (ALREADY DONE)

**Status:** ‚úÖ COMPLETE
**File:** `F:/Dropbox/dexbot/perp-dex-tools-original/hedge/DN_alternate_backpack_grvt.py`
**Location:** Line 750

**Current Code:**
```python
# OPTIMIZATION: Reduced timeout from 10s to 5s for faster execution
# Expected: 50% speed improvement (77s ‚Üí <50s per cycle)
# Tradeoff: Fill rate may drop from 95% to 80-90%
if time.time() - start_time > 5:
```

**Action Required:** None - already optimized

**Acceptance Criteria:**
- [x] Timeout set to 5 seconds
- [x] Comment documents expected tradeoffs
- [ ] Validate fill rate in production test

---

### Task 2: Convert GRVT Hedge to POST_ONLY (NEW)

**Status:** ‚è≥ PENDING
**Risk Level:** MEDIUM
**Files Modified:**
- `F:/Dropbox/dexbot/perp-dex-tools-original/hedge/DN_alternate_backpack_grvt.py` (main logic)
- `F:/Dropbox/dexbot/perp-dex-tools-original/hedge/exchanges/grvt.py` (GRVT implementation)

#### 2.1 Add POST_ONLY Configuration Parameter

**File:** `F:/Dropbox/dexbot/perp-dex-tools-original/hedge/DN_alternate_backpack_grvt.py`
**Location:** Lines 90-97 (class constructor parameters)

**Change:**
```python
# ADD after line 96 (hedge_mode parameter):
hedge_post_only: bool = True,  # Use POST_ONLY for hedge to save 0.05% taker fee
```

**Location:** Line 108 (instance variable assignment)

**Change:**
```python
# ADD after line 108:
self.hedge_post_only = hedge_post_only
```

**Acceptance Criteria:**
- [ ] Parameter added with default value `True`
- [ ] Instance variable properly initialized
- [ ] Backward compatible (default to POST_ONLY)

---

#### 2.2 Modify Hedge Order Placement Logic

**File:** `F:/Dropbox/dexbot/perp-dex-tools-original/hedge/DN_alternate_backpack_grvt.py`
**Location:** Lines 900-1000 (hedge order placement)

**Current Logic (MARKET):**
```python
# Place market order for hedge
hedge_result = await self.hedge_client.place_market_order(
    contract_id=self.hedge_contract_id,
    quantity=self.current_hedge_quantity,
    side=self.current_hedge_side
)
```

**New Logic (POST_ONLY with Fallback):**
```python
# NEW: Try POST_ONLY first for 0% fee, fall back to MARKET if needed
if self.hedge_post_only:
    # Get BBO for POST_ONLY pricing
    hedge_best_bid, hedge_best_ask = await self.hedge_client.fetch_bbo_prices(
        self.hedge_contract_id
    )

    # Calculate POST_ONLY price (1 tick inside spread)
    if self.current_hedge_side == "buy":
        hedge_post_only_price = hedge_best_ask - self.hedge_tick_size
    else:  # sell
        hedge_post_only_price = hedge_best_bid + self.hedge_tick_size

    hedge_post_only_price = self.hedge_client.round_to_tick(hedge_post_only_price)

    self.logger.info(
        f"[HEDGE] Attempting POST_ONLY @ {hedge_post_only_price} "
        f"(side: {self.current_hedge_side}, fee: 0%)"
    )

    # Try POST_ONLY with 3 second timeout
    try:
        hedge_result = await asyncio.wait_for(
            self.hedge_client.place_post_only_order(
                contract_id=self.hedge_contract_id,
                quantity=self.current_hedge_quantity,
                price=hedge_post_only_price,
                side=self.current_hedge_side
            ),
            timeout=3.0
        )

        if hedge_result.success and hedge_result.status == "FILLED":
            self.logger.info(
                f"[HEDGE] POST_ONLY filled: {hedge_result.side.upper()} "
                f"{hedge_result.size} @ {hedge_result.price} (0% fee saved)"
            )
            # Update local position
            if hedge_result.side == "buy":
                self.hedge_client._local_position += hedge_result.size
            else:
                self.hedge_client._local_position -= hedge_result.size
            return hedge_result
        elif hedge_result.status == "OPEN":
            # POST_ONLY accepted but not filled - cancel and fallback
            self.logger.warning(
                f"[HEDGE] POST_ONLY not filled within 3s, canceling and falling back to MARKET"
            )
            await self.hedge_client.cancel_order(hedge_result.order_id)
        else:
            self.logger.warning(
                f"[HEDGE] POST_ONLY rejected (status: {hedge_result.status}), falling back to MARKET"
            )

    except asyncio.TimeoutError:
        self.logger.warning(
            f"[HEDGE] POST_ONLY timeout after 3s, falling back to MARKET"
        )
    except Exception as e:
        self.logger.error(
            f"[HEDGE] POST_ONLY failed: {e}, falling back to MARKET"
        )

# FALLBACK: Use MARKET order (0.05% taker fee)
self.logger.info(
    f"[HEDGE] Using MARKET order (0.05% taker fee applies)"
)
hedge_result = await self.hedge_client.place_market_order(
    contract_id=self.hedge_contract_id,
    quantity=self.current_hedge_quantity,
    side=self.current_hedge_side
)
```

**Acceptance Criteria:**
- [ ] POST_ONLY attempted first with 3s timeout
- [ ] Price calculated 1 tick inside spread
- [ ] Fallback to MARKET if POST_ONLY not filled
- [ ] Proper logging for both success and fallback
- [ ] Local position updated correctly for POST_ONLY fills
- [ ] Error handling for timeout and exceptions
- [ ] No code path leaves position untracked

---

#### 2.3 Update Logging and Metrics

**File:** `F:/Dropbox/dexbot/perp-dex-tools-original/hedge/DN_alternate_backpack_grvt.py`
**Location:** Lines 46-76 (TradeMetrics dataclass)

**Change:**
```python
# ADD to TradeMetrics dataclass after line 76:
hedge_order_type: str = "MARKET"  # "POST_ONLY" or "MARKET"
hedge_fee_saved: bool = False  # True if POST_ONLY filled
```

**Location:** TradeMetrics initialization (multiple locations)

**Change:**
```python
# When creating TradeMetrics, add:
hedge_order_type="POST_ONLY" if hedge_result.from_post_only else "MARKET",
hedge_fee_saved=hedge_result.from_post_only if hedge_result.from_post_only else False
```

**Acceptance Criteria:**
- [ ] TradeMetrics tracks POST_ONLY vs MARKET
- [ ] Fee savings recorded in metrics
- [ ] CSV export includes new fields
- [ ] Analysis can calculate actual fee savings

---

### Task 3: Add POST_ONLY Tracking to OrderResult

**Status:** ‚è≥ PENDING
**File:** `F:/Dropbox/dexbot/perp-dex-tools-original/hedge/exchanges/base.py` or local equivalent
**Location:** OrderResult class definition

**Change:**
```python
# ADD field to OrderResult:
from_post_only: bool = False  # True if filled via POST_ONLY order
```

**Update place_post_only_order return:**
```python
# In grvt.py place_post_only_order, line ~394:
return OrderResult(
    success=True,
    order_id=order_info.order_id,
    side=side,
    size=quantity,
    price=order_price,
    status=order_status,
    from_post_only=True  # NEW: Track POST_ONLY fills
)
```

**Acceptance Criteria:**
- [ ] OrderResult includes `from_post_only` field
- [ ] place_post_only_order sets flag to True
- [ ] place_market_order sets flag to False
- [ ] Metrics can track fee savings

---

### Task 4: Update Command-Line Arguments

**Status:** ‚è≥ PENDING
**File:** `F:/Dropbox/dexbot/perp-dex-tools-original/hedge/DN_alternate_backpack_grvt.py`
**Location:** Lines 2040-2060 (argument parser)

**Change:**
```python
# ADD after --hedge-mode argument:
parser.add_argument(
    "--hedge-post-only",
    action="store_true",
    default=True,
    help="Use POST_ONLY for hedge orders to save 0.05% taker fee (default: True)",
)
parser.add_argument(
    "--hedge-market",
    action="store_true",
    default=False,
    help="Use MARKET for hedge orders (0.05% taker fee) - disables POST_ONLY",
)
```

**Location:** Lines 2101-2104 (bot initialization)

**Change:**
```python
# MODIFY hedge_mode assignment:
hedge_post_only = args.hedge_post_only and not args.hedge_market
hedge_mode = PriceMode(args.hedge_mode)

bot = DNHedgeBot(
    # ... existing parameters ...
    hedge_mode=hedge_mode,
    hedge_post_only=hedge_post_only,  # ADD THIS LINE
    min_spread_bps=Decimal(args.min_spread),
)
```

**Acceptance Criteria:**
- [ ] `--hedge-post-only` flag added (default True)
- [ ] `--hedge-market` flag added to override
- [ ] Bot initialization accepts hedge_post_only parameter
- [ ] Help text clear on fee implications

---

### Task 5: Validation Testing

**Status:** ‚è≥ PENDING
**Test Command:**
```bash
cd F:/Dropbox/dexbot/perp-dex-tools-original/hedge
python DN_alternate_backpack_grvt.py --ticker ETH --size 0.01 --iter 5 --primary backpack --hedge grvt
```

**Success Criteria:**
1. **Cycle Time:**
   - Average cycle time <25 seconds
   - No timeout errors (5s primary timeout)
   - 5/5 cycles complete successfully

2. **Fill Rate:**
   - POST_ONLY fill rate ‚â•60% (3+ out of 5 cycles)
   - No cycles fail due to hedge non-fill
   - Fallback to MARKET works correctly

3. **Fee Savings:**
   - Net PnL improves by ‚â•$0.20 vs baseline
   - Gross PnL similar or better (no slippage degradation)
   - CSV shows hedge_order_type="POST_ONLY" for successful cases

4. **Position Tracking:**
   - All positions close to 0.000 or -0.000 (no residual)
   - No emergency unwinds triggered
   - Local position matches exchange position

**Acceptance Criteria:**
- [ ] 5/5 iterations complete without errors
- [ ] Average cycle time <25s
- [ ] POST_ONLY fills ‚â•60% of hedge orders
- [ ] Net PnL positive and improved vs baseline
- [ ] No residual positions
- [ ] CSV export includes new metrics

---

## Risk Mitigation

### Risk 1: POST_ONLY Non-Fill (MEDIUM)

**Description:** POST_ONLY orders may not fill if market moves away, causing delays.

**Mitigation:**
1. **3-Second Timeout:** Attempt POST_ONLY for 3s max before fallback
2. **Automatic Fallback:** Convert to MARKET if POST_ONLY not filled
3. **Price Placement:** 1 tick inside spread for best chance of fill
4. **Monitoring:** Track POST_ONLY fill rate, adjust timeout if needed

**Rollback Plan:**
- If fill rate <50%, increase timeout to 5s
- If fill rate <30%, disable POST_ONLY (`--hedge-market` flag)
- Monitor for 20 cycles before deciding

**Acceptance Criteria:**
- [ ] Fallback logic tested and working
- [ ] Timeout value configurable (3s default)
- [ ] Rollback procedure documented
- [ ] Monitoring dashboard tracks fill rate

---

### Risk 2: Timeout Edge Cases (LOW)

**Description:** 5s timeout may be too aggressive during volatility, causing false cancels.

**Mitigation:**
1. **Already Implemented:** Timeout is 5s at line 750
2. **Validation:** Monitor fill rate during test
3. **Adjustable:** Can increase to 7s if needed
4. **Logging:** Track timeout-triggered cancels

**Rollback Plan:**
- If timeout cancels >20% of orders, increase to 7s
- If timeout cancels >40% of orders, increase to 10s (original)

**Acceptance Criteria:**
- [ ] Timeout value logged for each cancel
- [ ] Fill rate ‚â•80% maintained
- [ ] No adverse position impact from early cancels

---

### Risk 3: Position Desync (LOW)

**Description:** POST_ONLY fills may not update local position correctly.

**Mitigation:**
1. **REST API Sync:** Verify position after POST_ONLY fill
2. **Explicit Update:** Manually update `_local_position` on POST_ONLY fill
3. **Validation:** Check position matches exchange after each cycle
4. **Error Handling:** Raise exception if position mismatch detected

**Rollback Plan:**
- Add additional sync calls if desync detected
- Disable POST_ONLY if position errors persist

**Acceptance Criteria:**
- [ ] All positions reconcile to 0.000
- [ ] No emergency unwinds from position errors
- [ ] WebSocket and REST positions match

---

## Testing Strategy

### Phase 1: Dry Run Validation (5 iterations)

**Command:**
```bash
python DN_alternate_backpack_grvt.py --ticker ETH --size 0.01 --iter 5 --primary backpack --hedge grvt --hedge-post-only
```

**Checks:**
- [ ] All 5 iterations complete
- [ ] No errors or exceptions
- [ ] CSV generated with new metrics
- [ ] Average cycle time recorded

**Pass Criteria:** 5/5 cycles complete, no crashes

---

### Phase 2: Performance Measurement (10 iterations)

**Command:**
```bash
python DN_alternate_backpack_grvt.py --ticker ETH --size 0.01 --iter 10 --primary backpack --hedge grvt --hedge-post-only
```

**Metrics:**
- [ ] Average cycle time vs 33.32s baseline
- [ ] POST_ONLY fill rate (target ‚â•60%)
- [ ] Net PnL vs -$0.158 baseline
- [ ] Gross PnL vs +$2.70 baseline
- [ ] Fee savings per cycle

**Pass Criteria:**
- Cycle time <25s
- Net PnL ‚â•$0.00 (break-even or better)
- POST_ONLY fill rate ‚â•60%

---

### Phase 3: Stress Test (20 iterations)

**Command:**
```bash
python DN_alternate_backpack_grvt.py --ticker ETH --size 0.01 --iter 20 --primary backpack --hedge grvt --hedge-post-only
```

**Checks:**
- [ ] Consistent performance over 20 cycles
- [ ] No memory leaks or performance degradation
- [ ] Position tracking remains accurate
- [ ] Error rate remains low (<5%)

**Pass Criteria:** 18+ cycles successful, stable metrics

---

### Phase 4: Fallback Validation

**Test POST_ONLY fallback by forcing market movement:**

1. **Manual Test:** Run during volatile market conditions
2. **Force Fallback:** Temporarily set POST_ONLY price far from market
3. **Verify Fallback:** Confirm MARKET order executes correctly
4. **Check Position:** Verify position matches after fallback

**Pass Criteria:** Fallback activates, MARKET executes, position correct

---

## Rollback Plan

### Immediate Rollback (Critical Issues)

**Triggers:**
- Emergency unwind triggered
- Position desync >0.01 ETH
- Net PnL significantly worse (-$2.00+ per cycle)
- System crashes or hangs

**Actions:**
1. Stop bot immediately
2. Use `--hedge-market` flag to disable POST_ONLY
3. Revert to MARKET orders (0.05% taker fee)
4. Investigate logs for root cause

**Command:**
```bash
python DN_alternate_backpack_grvt.py --ticker ETH --size 0.01 --iter 5 --primary backpack --hedge grvt --hedge-market
```

---

### Gradual Rollback (Performance Issues)

**Triggers:**
- POST_ONLY fill rate <40%
- Cycle time >30s (no improvement)
- Net PnL worse than baseline

**Actions:**
1. Increase POST_ONLY timeout: 3s ‚Üí 5s
2. Adjust POST_ONLY price: 1 tick ‚Üí 2 ticks inside spread
3. If still poor, disable POST_ONLY

**Configuration Changes:**
```python
# In hedge order placement logic, modify:
timeout=5.0  # Increased from 3.0
# OR
hedge_post_only_price = hedge_best_ask - (self.hedge_tick_size * 2)  # More aggressive
```

---

### Code Revert (Full Rollback)

**If all else fails, revert changes:**

1. **Git Revert:**
   ```bash
   git checkout HEAD~1 -- DN_alternate_backpack_grvt.py
   git checkout HEAD~1 -- exchanges/grvt.py
   ```

2. **Manual Revert:**
   - Remove `hedge_post_only` parameter
   - Remove POST_ONLY logic in hedge placement
   - Restore original MARKET order call
   - Remove `from_post_only` field from OrderResult

**Acceptance Criteria:**
- [ ] Rollback procedure tested
- [ ] Git history preserved
- [ ] Original functionality restored

---

## Success Metrics

### Primary Metrics

| Metric | Baseline | Target | Measurement |
|--------|----------|--------|-------------|
| **Cycle Time** | 33.32s | <25s | Average across 10 cycles |
| **POST_ONLY Fill Rate** | N/A | ‚â•60% | % of hedge orders filled via POST_ONLY |
| **Fee Savings** | $0.00 | ‚â•$0.50/cycle | 0.05% √ó hedge quantity √ó price |
| **Net PnL** | -$0.158 | ‚â•$0.00 | Per cycle (5 iterations) |
| **Gross PnL** | +$2.70 | ‚â•+$2.50 | Per cycle (ensure no degradation) |

---

### Secondary Metrics

| Metric | Baseline | Target | Measurement |
|--------|----------|--------|-------------|
| **Success Rate** | 100% (10/10) | ‚â•95% | % of cycles complete without error |
| **Position Accuracy** | 0.000 | ¬±0.001 | Final position after all closes |
| **Timeout Rate** | 0% | <10% | % of orders cancelled due to timeout |
| **Fallback Rate** | N/A | <40% | % of hedge orders falling back to MARKET |
| **Emergency Unwinds** | 0 | 0 | Count of emergency unwind events |

---

### Validation Checklist

**Post-Test Validation:**

- [ ] 5/5 test iterations complete successfully
- [ ] Average cycle time <25s
- [ ] POST_ONLY fill rate ‚â•60%
- [ ] Net PnL ‚â•$0.00 (break-even or better)
- [ ] Gross PnL ‚â•$2.50 (no slippage degradation)
- [ ] All positions close to 0.000 (no residual)
- [ ] No emergency unwinds triggered
- [ ] CSV export includes `hedge_order_type` and `hedge_fee_saved`
- [ ] Logs show POST_ONLY attempts and fallbacks clearly
- [ ] No errors or exceptions in logs

**Sign-off Criteria:**
- All 10 validation checks pass
- Net improvement in PnL or cycle time achieved
- No critical bugs or safety issues identified

---

## Implementation Notes

### Code Architecture

**Current Flow:**
1. Primary order placed (POST_ONLY on Backpack)
2. Wait for primary fill (5s timeout, line 750)
3. Hedge order placed (MARKET on GRVT)
4. Wait for hedge fill
5. Close both legs

**New Flow:**
1. Primary order placed (POST_ONLY on Backpack)
2. Wait for primary fill (5s timeout, line 750)
3. **NEW:** Try POST_ONLY on GRVT (3s timeout)
4. **NEW:** If POST_ONLY not filled, fallback to MARKET
5. Wait for hedge fill
6. Close both legs

**Key Files:**
- `DN_alternate_backpack_grvt.py` - Main bot logic
- `exchanges/grvt.py` - GRVT exchange implementation
- `exchanges/base.py` - Base exchange classes

---

### Configuration Examples

**Default (POST_ONLY enabled):**
```bash
python DN_alternate_backpack_grvt.py --ticker ETH --size 0.01 --iter 10
```

**Disable POST_ONLY (use MARKET):**
```bash
python DN_alternate_backpack_grvt.py --ticker ETH --size 0.01 --iter 10 --hedge-market
```

**Explicit POST_ONLY:**
```bash
python DN_alternate_backpack_grvt.py --ticker ETH --size 0.01 --iter 10 --hedge-post-only
```

---

### Fee Calculation Example

**Current (MARKET):**
- Hedge: 0.01 ETH @ $3000 = $30 notional
- Taker fee: 0.05% √ó $30 = $0.015
- 2 hedge legs per cycle = $0.03 total fee

**New (POST_ONLY 60% fill rate):**
- POST_ONLY fills: 60% √ó $0.03 = $0.018 saved
- MARKET fallback: 40% √ó $0.03 = $0.012 paid
- Net fee: $0.012 (60% reduction)

**Expected Net PnL Impact:**
- Baseline: -$0.158 per cycle
- Fee savings: +$0.018 per cycle
- Projected: -$0.140 per cycle (11% improvement)

---

## Handoff Checklist

**Before Implementation:**

- [ ] Plan reviewed and approved
- [ ] All tasks clearly defined with acceptance criteria
- [ ] Risk mitigation strategies documented
- [ ] Rollback procedures clear and tested
- [ ] Success metrics measurable and achievable

**After Implementation:**

- [ ] All code changes committed to git
- [ ] Unit tests pass (if applicable)
- [ ] Integration tests pass (5 iterations)
- [ ] Performance tests pass (10 iterations)
- [ ] Documentation updated (README, CHANGELOG)
- [ ] Team notified of changes

---

## References

**Related Files:**
- `F:/Dropbox/dexbot/perp-dex-tools-original/hedge/DN_alternate_backpack_grvt.py` - Main bot
- `F:/Dropbox/dexbot/perp-dex-tools-original/hedge/exchanges/grvt.py` - GRVT implementation
- `F:/Dropbox/dexbot/perp-dex-tools-original/hedge/exchanges/base.py` - Base classes

**Related Work:**
- Emergency unwind fix (line 1682: side‚Üídirection)
- Iterative market order implementation (lines 703-904)
- Enhanced retry logic (6 retries, exponential backoff)

**Baseline Performance:**
- 10/10 cycles successful
- Average cycle time: 33.32s
- Net PnL: -$0.158 (-0.55 bps)
- Gross PnL: +$2.70 (+10.39 bps)

---

**END OF PLAN**
